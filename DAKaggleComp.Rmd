---
title: "DA Kaggle Competition"
author: "Martin Gassner & Henry Mauranen"
date: "12 April 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libs}
library(readr)
library(ggplot2)
library(reshape2)
library(dplyr)
```

```{r imports}
sample_sol <- read_csv("data/sample_sol.csv")
test <- read_csv("data/test.csv")
train <- read_csv("data/train.csv")

#sample_sol <- read_csv("C:/Users/Henry/Desktop/DA Labs/DAKaggle/data/sample_sol.csv")
#test <- read_csv("C:/Users/Henry/Desktop/DA Labs/DAKaggle/data/test.csv")
#train <- read_csv("C:/Users/Henry/Desktop/DA Labs/DAKaggle/data/train.csv")
```

```{r overview}
#summary(clean.train)
#str(clean.train)

clean.train <- train[train$n_non_stop_words < 1000,]
clean.train <- clean.train[complete.cases(clean.train),]
clean.train <- clean.train[clean.train$shares < 10000,]

clean.train.melt <- melt(t(clean.train)) # Why transpose tho

ggplot(clean.train.melt, aes(x=value)) + geom_density() + facet_wrap(~X1,scales="free")
ggplot(clean.train.melt, aes(x=X1,y=value)) + geom_boxplot() + facet_wrap(~X1,scales="free")

```

```{r modelling}
clean.train.fit <- lm(shares~., data=clean.train)

relevant.cols <- c(6, 7, 8, 10, 11, 13, 14, 15, 16, 19, 20, 24, 25, 26, 27, 28, 32, 34, 37)
relevant.col.names <- colnames(clean.train)[relevant.cols]

lm.formula <- as.formula(paste0("shares~",paste(relevant.col.names, collapse = "+")))

relevant.train.fit <- lm(lm.formula, data=clean.train)

summary(relevant.train.fit)

tests.est <- test
tests.est$shares <- sample_sol$shares

test.model.mat <- model.matrix(shares~.,data=tests.est)

pred <- predict(relevant.train.fit, test)
errors <- mean(sqrt((sample_sol$shares-pred)^2))

pred <- data.frame(pred)

pred$id <- seq(1:9911)

mean(sqrt(relevant.train.fit$residuals^2))


```

```{r spm}
train.plot.data <- train[1:2000,]
train.plot.data$shares <- log(train.plot.data$shares)
train.melt.shares <- melt(train.plot.data, "shares")
ggplot(train.melt.shares, aes(x=value,y=shares)) + geom_point() + facet_wrap(~variable,scales="free")
```

```{r z-scores}
zscore <- function( xs ) (xs - mean( xs ) ) / sd( xs )
isSig <- function( zs.df, sd ) apply( zs.df, 1, function( zs ) any( zs > -sd && zs < sd ) )

train.zs <- sapply( trainData, zscore )

train.zs.sigs <- killSigs( trainData.zs, 1.5 )
```

```{r testing distributions}
for( n in colnames( testData ) )
{
  #print( n )
  #print( var.test( trainData[ ,n ], testData[ ,n ] ) )
  #print( t.test( trainData[ ,n ], testData[ ,n ] ) )
}
```

```{r lin regression with lasso}
trainData.mat <- as.matrix( trainData )
train.zs.mat <- as.matrix( train.zs )
testData.mat <- as.matrix( testData )

fit.lasso <- glmnet( x=trainData.mat[ ,-45 ], y=trainData.mat[ ,45 ], alpha=0.85, standardize = TRUE )
fit.lasso.cv <- cv.glmnet( x=trainData.mat[ ,-45 ], y=trainData.mat[ ,45 ], alpha=0.85 )
fit.lasso.bestIndex <- which.min( (fit.lasso$lambda - fit.lasso.cv$lambda.min)^2 )
fit.lasso.pred <- predict( fit.lasso.cv$glmnet.fit, trainData.mat[ ,-45 ] )
fit.lasso.testPred <- predict( fit.lasso.cv$glmnet.fit, testData.mat )

mean( abs( fit.lasso.pred[ ,fit.lasso.bestIndex ] - trainData[ ,45 ] ) )
bestTestPred.df <- as.data.frame( cbind( 1:nrow( fit.lasso.testPred )
                                         , fit.lasso.testPred[ ,fit.lasso.bestIndex ] ) )
colnames( bestTestPred.df ) <- c( "id", "shares" )
write.csv( bestTestPred.df
           , file="lassoPred.csv"
           , col.names = TRUE, row.names = FALSE
           , quote=FALSE )
```
